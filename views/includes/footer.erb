<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<link rel="stylesheet" href="/lib/codemirror.css">
<link rel='stylesheet' href="/addon/fold/foldgutter.css" />
<script src="/lib/codemirror.js"></script>
<script src="/addon/fold/foldcode.js"></script>
<script src="/addon/fold/foldgutter.js"></script>
<script src='/addon/edit/matchbrackets.js'></script>
<script src="/addon/fold/brace-fold.js"></script>
<script src="/addon/fold/comment-fold.js"></script>
<script src="/mode/css/css.js"></script>
<script>
    var myTextarea = document.querySelector('.js-sass');
    var editor = CodeMirror.fromTextArea(myTextarea, {
      matchBrackets: true,
      mode: "text/x-scss",
      lineNumbers:true,
      lineWrapping: true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
      foldGutter: true
    });
    editor.foldCode(CodeMirror.Pos(0, 0));
    var css = document.querySelector('.js-css');
    var csseditor = CodeMirror.fromTextArea(css, {
      mode: "css",
      readOnly: true,
      lineNumbers:true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
      foldGutter: true
    });
    csseditor.foldCode(CodeMirror.Pos(0, 0));
    var timer;
    editor.on('change', function(cm){
      clearTimeout(timer);
      timer = setTimeout(function(){
        $.ajax({
	  type: "POST",
	  url: '/compile',
	  data: { 'sass': cm.getValue()}
	}).done( function(res){
          $('.js-css').val( res );
          csseditor.getDoc().setValue(res);
        }).fail(function (err, msg){
        });
      }, 1000);
    });
    $('.js-save').on('click', function( event ){
      event.preventDefault(); 
      var data = editor.getValue();
      window.location.hash = btoa(data);
    });
    $(function(){
      var hash = window.location.hash.substr(1);
      console.log(hash);
      if ( hash ) {
        editor.getDoc().setValue( atob( hash ) );
      }
    });
</script>
  </body>
</html>
